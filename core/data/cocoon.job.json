{
  "Job": {
    "Region": "global",
    "ID": "{{ID}}",
    "Name": "{{ID}}",
    "Type": "service",
    "Priority": 50,
    "AllAtOnce": false,
    "Datacenters": [
      "dc1"
    ],
    "Constraints": [
      {
        "LTarget": "${attr.kernel.name}",
        "RTarget": "linux",
        "Operand": "="
      }
    ],
    "TaskGroups": [
      {
        "Name": "{{ID}}",
        "Count": {{Count}},
        "Constraints": null,
        "Tasks": [
          {
            "Name": "task-{{ID}}",
            "Driver": "docker",
            "Config": {
              "image": "{{Image}}",
              "force_pull": true,
              "command": "bash",
              "network_mode": "host",
              "args": ["${NOMAD_META_SCRIPTS_DIR}/${NOMAD_META_DEPLOY_SCRIPT_NAME}"],
              "privileged": true,
              "port_map": []
            },
            "Env": {
              "COCOON_ID": "{{ID}}",
              "COCOON_CODE_URL": "{{CocoonCodeURL}}",
              "COCOON_CODE_TAG": "{{CocoonCodeTag}}",
              "COCOON_CODE_LANG": "{{CocoonCodeLang}}",
              "COCOON_BUILD_PARAMS": "{{CocoonBuildParams}}",
              "COCOON_DISK_LIMIT": "{{DiskMB}}"
            },
            "Services": [{
              "Name": "cocoons-{{ID}}",
              "Tags": ["{{ID}}"],
              "PortLabel": "connector",
              "Checks": [{
                "Id": "",
                "Name": "alive",
                "Type": "tcp",
                "Path": "/ok",
                "Port": "connector-http",
                "Timeout": 2000000000,
                "Interval": 10000000000,
                "Protocol": "http"
              }]
            ],
            "Meta": {
              "DEPLOY_SCRIPT_NAME": "run-connector.sh",
              "SCRIPTS_DIR": "/local/scripts"
            },
            "LogConfig": {
              "MaxFiles": 10,
              "MaxFileSizeMB": 10
            },
            "Templates": [],
            "Artifacts": [{
                "GetterSource": "https://raw.githubusercontent.com/ncodes/cocoon/master/scripts/${NOMAD_META_DEPLOY_SCRIPT_NAME}",
                "RelativeDest": "/local/scripts"
            }],
            "Resources": {
              "CPU": {{CPU}},
              "MemoryMB": {{MemoryMB}},
              "IOPS": 0,
              "Networks": [
                {
                  "MBits": {{MBits}},
                  "DynamicPorts":[
                    { "Label":"connector"}
                    { "Label":"connector-http"}
                  ]
                }
              ]
            },
            "DispatchPayload": {}
          }
        ],
        "Resources": {
          "CPU": {{CPU}},
          "MemoryMB": {{MemoryMB}},
          "IOPS": 0,
          "Networks": []
        },
        "RestartPolicy": {
          "Interval": 300000000000,
          "Attempts": 10,
          "Delay": 25000000000,
          "Mode": "delay"
        },
        "Meta": {}
      }
    ],
    "Update": {
      "Stagger": 10000000000,
      "MaxParallel": 1
    }
  }
}